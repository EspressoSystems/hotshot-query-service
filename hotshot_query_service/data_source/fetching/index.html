<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="generator" content="rustdoc"><meta name="description" content="Asynchronous retrieval of missing data."><title>hotshot_query_service::data_source::fetching - Rust</title><script>if(window.location.protocol!=="file:")document.head.insertAdjacentHTML("beforeend","SourceSerif4-Regular-46f98efaafac5295.ttf.woff2,FiraSans-Regular-018c141bf0843ffd.woff2,FiraSans-Medium-8f9a781e4970d388.woff2,SourceCodePro-Regular-562dcc5011b6de7d.ttf.woff2,SourceCodePro-Semibold-d899c5a5c4aeb14a.ttf.woff2".split(",").map(f=>`<link rel="preload" as="font" type="font/woff2" crossorigin href="../../../static.files/${f}">`).join(""))</script><link rel="stylesheet" href="../../../static.files/normalize-76eba96aa4d2e634.css"><link rel="stylesheet" href="../../../static.files/rustdoc-492a78a4a87dcc01.css"><meta name="rustdoc-vars" data-root-path="../../../" data-static-root-path="../../../static.files/" data-current-crate="hotshot_query_service" data-themes="" data-resource-suffix="" data-rustdoc-version="1.82.0 (f6e511eec 2024-10-15)" data-channel="1.82.0" data-search-js="search-a99f1315e7cc5121.js" data-settings-js="settings-4313503d2e1961c2.js" ><script src="../../../static.files/storage-118b08c4c78b968e.js"></script><script defer src="../sidebar-items.js"></script><script defer src="../../../static.files/main-921df33f47b8780c.js"></script><noscript><link rel="stylesheet" href="../../../static.files/noscript-3b12f09e550e0385.css"></noscript><link rel="alternate icon" type="image/png" href="../../../static.files/favicon-32x32-422f7d1d52889060.png"><link rel="icon" type="image/svg+xml" href="../../../static.files/favicon-2c020d218678b618.svg"></head><body class="rustdoc mod"><!--[if lte IE 11]><div class="warning">This old browser is unsupported and will most likely display funky things.</div><![endif]--><nav class="mobile-topbar"><button class="sidebar-menu-toggle" title="show sidebar"></button></nav><nav class="sidebar"><div class="sidebar-crate"><h2><a href="../../../hotshot_query_service/index.html">hotshot_<wbr>query_<wbr>service</a><span class="version">0.1.62</span></h2></div><h2 class="location"><a href="#">Module fetching</a></h2><div class="sidebar-elems"><section><ul class="block"><li><a href="#structs">Structs</a></li><li><a href="#traits">Traits</a></li></ul></section><h2><a href="../index.html">In hotshot_<wbr>query_<wbr>service::<wbr>data_<wbr>source</a></h2></div></nav><div class="sidebar-resizer"></div><main><div class="width-limiter"><rustdoc-search></rustdoc-search><section id="main-content" class="content"><div class="main-heading"><h1>Module <a href="../../index.html">hotshot_query_service</a>::<wbr><a href="../index.html">data_source</a>::<wbr><a class="mod" href="#">fetching</a><button id="copy-path" title="Copy item path to clipboard">Copy item path</button></h1><span class="out-of-band"><a class="src" href="../../../src/hotshot_query_service/data_source/fetching.rs.html#13-1355">source</a> · <button id="toggle-all-docs" title="collapse all docs">[<span>&#x2212;</span>]</button></span></div><details class="toggle top-doc" open><summary class="hideme"><span>Expand description</span></summary><div class="docblock"><p>Asynchronous retrieval of missing data.</p>
<p><a href="struct.FetchingDataSource.html" title="struct hotshot_query_service::data_source::fetching::FetchingDataSource"><code>FetchingDataSource</code></a> combines a local storage implementation with a remote data availability
provider to create a data sources which caches data locally, but which is capable of fetching
missing data from a remote source, either proactively or on demand.</p>
<p>This implementation supports three kinds of data fetching.</p>
<h2 id="proactive-fetching"><a class="doc-anchor" href="#proactive-fetching">§</a>Proactive Fetching</h2>
<p>Proactive fetching means actively scanning the local database for missing objects and
proactively retrieving them from a remote provider, even if those objects have yet to be
requested by a client. Doing this increases the chance of success and decreases latency when a
client does eventually ask for those objects. This is also the mechanism by which a query
service joining a network late, or having been offline for some time, is able to catch up with
the events on the network that it missed.</p>
<p>The current implementation of proactive fetching is meant to be the simplest effective algorithm
which still gives us a reasonable range of configuration options for experimentation. It is
subject to change as we learn about the behavior of proactive fetching in a realistic system.</p>
<p>Proactive fetching is currently implemented by a background task which performs periodic scans
of the database, identifying and retrieving missing objects. This task is generally low
priority, since missing objects are rare, and it will take care not to monopolize resources that
could be used to serve requests. To reduce load and to optimize for the common case where blocks
are usually not missing once they have already been retrieved, we distinguish between <em>major</em>
and <em>minor</em> scans.</p>
<p>Minor scans are lightweight and can run very frequently. They will only look for missing
blocks among blocks that are new since the previous scan. Thus, the more frequently minor
scans run, the less work they have to do. This allows them to run frequently, giving low
latency for retrieval of newly produced blocks that we failed to receive initially. Between
each minor scan, the task will sleep for <a href="struct.Builder.html#method.with_minor_scan_interval" title="method hotshot_query_service::data_source::fetching::Builder::with_minor_scan_interval">a configurable
duration</a> to wait for new blocks to be produced and give
other tasks full access to all shared resources.</p>
<p>Every <code>n</code>th scan (<code>n</code> is <a href="struct.Builder.html#method.with_major_scan_interval" title="method hotshot_query_service::data_source::fetching::Builder::with_major_scan_interval">configurable</a>) is a major scan.
These scan all blocks from 0, which guarantees that we will eventually retrieve all blocks, even
if for some reason we have lost a block that we previously had (due to storage failures and
corruptions, or simple bugs in this software). These scans are rather expensive (although they
will release control of shared resources many times during the duration of the scan), but
because it is rather unlikely that a major scan will discover any missing blocks that the next
minor scan would have missed, it is ok if major scans run very infrequently.</p>
<h2 id="active-fetching"><a class="doc-anchor" href="#active-fetching">§</a>Active Fetching</h2>
<p>Active fetching means reaching out to a remote data availability provider to retrieve a missing
resource, upon receiving a request for that resource from a client. Not every request for a
missing resource triggers an active fetch. To avoid spamming peers with requests for missing
data, we only actively fetch resources that are known to exist somewhere. This means we can
actively fetch leaves and headers when we are requested a leaf or header by height, whose height
is less than the current chain height. We can fetch a block when the corresponding header exists
(corresponding based on height, hash, or payload hash) or can be actively fetched.</p>
<h2 id="passive-fetching"><a class="doc-anchor" href="#passive-fetching">§</a>Passive Fetching</h2>
<p>For requests that cannot be actively fetched (for example, a block requested by hash, where we
do not have a header proving that a block with that hash exists), we use passive fetching. This
essentially means waiting passively until the query service receives an object that satisfies
the request. This object may be received because it was actively fetched in responsive to a
different request for the same object, one that permitted an active fetch. Or it may have been
fetched <a href="#proactive-fetching">proactively</a>.</p>
</div></details><h2 id="structs" class="section-header">Structs<a href="#structs" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="struct" href="struct.Builder.html" title="struct hotshot_query_service::data_source::fetching::Builder">Builder</a></div><div class="desc docblock-short">Builder for <a href="struct.FetchingDataSource.html" title="struct hotshot_query_service::data_source::fetching::FetchingDataSource"><code>FetchingDataSource</code></a> with configuration.</div></li><li><div class="item-name"><a class="struct" href="struct.FetchingDataSource.html" title="struct hotshot_query_service::data_source::fetching::FetchingDataSource">Fetching<wbr>Data<wbr>Source</a></div><div class="desc docblock-short">The most basic kind of data source.</div></li><li><div class="item-name"><a class="struct" href="struct.Pruner.html" title="struct hotshot_query_service::data_source::fetching::Pruner">Pruner</a></div></li><li><div class="item-name"><a class="struct" href="struct.Transaction.html" title="struct hotshot_query_service::data_source::fetching::Transaction">Transaction</a></div></li></ul><h2 id="traits" class="section-header">Traits<a href="#traits" class="anchor">§</a></h2><ul class="item-table"><li><div class="item-name"><a class="trait" href="trait.AvailabilityProvider.html" title="trait hotshot_query_service::data_source::fetching::AvailabilityProvider">Availability<wbr>Provider</a></div><div class="desc docblock-short">A provider which can be used as a fetcher by the availability service.</div></li></ul></section></div></main></body></html>